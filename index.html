<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, orientation=landscape">
    <title>Childhood Journey - Notebook Adventure</title>
    <!-- Import font chu viet tay Patrick Hand -->
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100dvh; /* FIX MOBILE: Dung dvh de khong bi lap boi thanh dia chi trinh duyet */
            background-color: #f0f0f0;
            font-family: 'Patrick Hand', cursive;
            overflow: hidden;
            touch-action: none;
        }

        #game-container {
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 3px solid #444; 
            background-color: #e1f5fe; 
            background-image:
                linear-gradient(rgba(33, 150, 243, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(33, 150, 243, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            width: 800px;
            height: 400px;
            max-width: 100vw;
            max-height: 100dvh; /* FIX MOBILE */
            aspect-ratio: 2 / 1; /* Giu ty le chuan */
            border-radius: 5px;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #orientation-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        @media (orientation: portrait) {
            #orientation-overlay { display: flex; }
        }

        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 100;
        }

        .screen {
            display: none;
            text-align: center;
            pointer-events: auto;
            background: #fff;
            padding: 20px 40px;
            border-radius: 2px;
            border: 2px solid #444; 
            box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
            max-width: 85%;
            max-height: 90%;
            overflow-y: auto;
        }

        .screen.active { display: block; }

        h1 {
            color: #333;
            font-size: 42px;
            margin: 0 0 5px 0;
            text-decoration: underline;
            text-decoration-style: wavy;
        }

        .instructions {
            background: #fff;
            padding: 10px;
            border: 1px dashed #555; 
            margin-bottom: 10px;
        }

        .instructions p {
            font-size: 18px;
            margin: 3px 0;
            color: #333;
            text-align: left;
        }

        .copyright {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            border-top: 1px solid #ccc;
            padding-top: 5px;
            line-height: 1.2;
        }

        #score-display {
            position: absolute;
            top: 15px;
            left: 20px;
            font-size: 32px;
            font-weight: bold;
            color: #333;
            background: rgba(255, 255, 255, 0.5); 
            padding: 5px 15px;
            border: 2px solid #444; 
            z-index: 40;
            box-shadow: 2px 2px 0 #ccc;
        }

        button {
            padding: 10px 40px;
            font-size: 26px;
            cursor: pointer;
            background-color: #fff;
            color: #333;
            border: 2px solid #444; 
            border-radius: 255px 15px 225px 15px / 15px 225px 15px 255px;
            transition: transform 0.2s, background-color 0.2s;
            font-family: 'Patrick Hand', cursive;
            font-weight: bold;
            box-shadow: 3px 3px 0 #555;
        }
        
        button:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #555;
        }

        #touch-zones {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            z-index: 60;
        }

        .zone {
            background: transparent;
            -webkit-tap-highlight-color: transparent;
        }

        #message-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #fff;
            color: #d32f2f;
            padding: 10px 20px;
            border: 2px solid #444;
            font-size: 20px;
            font-weight: bold;
            display: none;
            pointer-events: none;
            z-index: 150;
            box-shadow: 2px 2px 0 #555;
        }
    </style>
</head>
<body>
    <div id="orientation-overlay">
        <div style="font-size: 50px;">ðŸ”„</div>
        <h2>Please rotate your screen</h2>
        <p>For the best adventure experience!</p>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="score-display">Score: 0 | Best: 0</div>
        
        <div id="ui-overlay">
            <div id="start-screen" class="screen active">
                <h1>Kid's Notebook Journey</h1>
                
                <div class="instructions">
                    <p><strong>How to Play:</strong></p>
                    <p>â€¢ TOP LEFT: Hold to move RIGHT (Forward)</p>
                    <p>â€¢ BOTTOM LEFT: Hold to move LEFT (Backward)</p>
                    <p>â€¢ TOP RIGHT: Tap to JUMP</p>
                    <p>â€¢ BOTTOM RIGHT: Tap to DUCK</p>
                </div>

                <button onclick="startGame()">Start Game</button>
                <div class="copyright">
                    Copyright: Tráº§n Há»“ng DÃ¢n<br>
                    Email: tranhongdan@tranphudlk.edu.vn
                </div>
            </div>

            <div id="game-over-screen" class="screen">
                <h1>OOPS!</h1>
                <p id="final-score" style="font-size: 24px;">Score: 0 | Best: 0</p>
                <button onclick="startGame()">Play Again</button>
                <div class="copyright">
                    Copyright: Tráº§n Há»“ng DÃ¢n<br>
                    tranhongdan@tranphudlk.edu.vn
                </div>
            </div>
        </div>

        <div id="touch-zones" style="display: none;">
            <div class="zone" data-key="ArrowRight" id="zone-tl"></div>
            <div class="zone" data-key="ArrowUp" id="zone-tr"></div>
            <div class="zone" data-key="ArrowLeft" id="zone-bl"></div>
            <div class="zone" data-key="ArrowDown" id="zone-br"></div>
        </div>
        
        <div id="message-box"></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const messageBox = document.getElementById('message-box');
        const scoreElement = document.getElementById('score-display');
        const finalScoreElement = document.getElementById('final-score');
        const touchZonesContainer = document.getElementById('touch-zones');

        canvas.width = 800;
        canvas.height = 400;

        let gameState = 'START';
        let player = {};
        let platforms = [];
        let enemies = [];
        let clouds = [];
        let vines = [];
        let ziplines = [];
        let particles = [];
        let items = [];     
        let bullets = [];   
        let keys = {};
        let score = 0;
        let bestScore = parseInt(localStorage.getItem('notebook_best')) || 0;
        let cameraX = 0;
        let lastGeneratedX = 0;
        let activeTouches = {}; 

        // --- HE THONG AM THANH WEB AUDIO API ---
        let audioCtx;

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // Ham tao am thanh co ban
        function playTone(freq, type, duration, vol=0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // Am thanh nhay
        function playJumpSound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(300, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.15);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.15);
        }

        // Am thanh an vat pham
        function playItemSound() {
            if (!audioCtx) return;
            playTone(800, 'sine', 0.1, 0.1);
            setTimeout(() => playTone(1200, 'sine', 0.2, 0.1), 100);
        }

        // Am thanh ban sung
        function playShootSound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // Am thanh dap/tieu diet quai
        function playHitEnemySound() {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        // Am thanh thua game
        function playGameOverSound() {
            if (!audioCtx) return;
            const t = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(300, t);
            osc.frequency.setValueAtTime(250, t + 0.2);
            osc.frequency.setValueAtTime(200, t + 0.4);
            osc.frequency.exponentialRampToValueAtTime(50, t + 1.0);
            
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 1.0);
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(t + 1.0);
        }

        // --- HELPER DE VE NET VE TAY (DOODLE STYLE) ---
        function setDoodleStyle(ctx, color = '#333', width = 2) {
            ctx.strokeStyle = '#333';
            ctx.lineWidth = width;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = color;
        }

        // --- KHOI TAO GAME ---
        function initGame() {
            score = 0; cameraX = 0; lastGeneratedX = 0;
            updateScoreUI();

            player = { 
                x: 100, y: 200, width: 30, height: 45, 
                velX: 0, velY: 0, baseSpeed: 5, speed: 5, baseJumpForce: 11, jumpForce: 11, 
                grounded: false, isDucking: false, canDoubleJump: true, 
                isClimbing: false, isZipping: false, 
                frameCount: 0, dir: -1, 
                // Timers va max timers cho vat pham (hien thi pie chart)
                highJumpTimer: 0, invincibleTimer: 0, gunTimer: 0, speedTimer: 0,
                highJumpMax: 1200, invincibleMax: 1200, gunMax: 1200, speedMax: 1200
             };

            platforms = [{ x: 0, y: 350, width: 800, height: 50, type: 'ground' }];
            enemies = []; particles = []; vines = []; ziplines = []; items = []; bullets = [];
            clouds = [];
            
            for(let i=0; i<6; i++) {
                clouds.push({ 
                    x: Math.random() * canvas.width, 
                    y: Math.random() * 150 + 20, 
                    speed: 0.05 + Math.random() * 0.1, 
                    size: 30 + Math.random() * 30 
                });
            }

            lastGeneratedX = 800;
            for(let i=0; i<8; i++) spawnNextChunk();
            
            keys = {};
            activeTouches = {};
        }

        function startGame() {
            initAudio(); // Khoi tao am thanh khi user tuong tac
            initGame();
            gameState = 'PLAYING';
            startScreen.classList.remove('active');
            gameOverScreen.classList.remove('active');
            touchZonesContainer.style.display = 'grid';
        }

        function updateScoreUI() {
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('notebook_best', Math.floor(bestScore));
            }
            scoreElement.innerText = "Score: " + Math.floor(score) + " | Best: " + Math.floor(bestScore);
        }

        // --- XU LY DIEU KHIEN ---
        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        const handleTouch = (e) => {
            if (gameState !== 'PLAYING') return;
            e.preventDefault();

            for (let i = 0; i < e.changedTouches.length; i++) {
                const touch = e.changedTouches[i];
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const touchId = touch.identifier;

                if (e.type === 'touchstart' || e.type === 'touchmove') {
                    const newKey = target ? target.getAttribute('data-key') : null;
                    const oldKey = activeTouches[touchId];

                    if (newKey !== oldKey) {
                        if (oldKey) keys[oldKey] = false;
                        if (newKey) {
                            keys[newKey] = true;
                            activeTouches[touchId] = newKey;
                        } else {
                            delete activeTouches[touchId];
                        }
                    }
                } else if (e.type === 'touchend' || e.type === 'touchcancel') {
                    const keyToRelease = activeTouches[touchId];
                    if (keyToRelease) {
                        keys[keyToRelease] = false;
                        delete activeTouches[touchId];
                    }
                }
            }
        };

        touchZonesContainer.addEventListener('touchstart', handleTouch, { passive: false });
        touchZonesContainer.addEventListener('touchmove', handleTouch, { passive: false });
        touchZonesContainer.addEventListener('touchend', handleTouch, { passive: false });
        touchZonesContainer.addEventListener('touchcancel', handleTouch, { passive: false });

        function spawnNextChunk() {
            const rand = Math.random();
            let nextX = lastGeneratedX + 120 + Math.random() * 60;
            let nextY = 220 + Math.random() * 100;
            let width = 250 + Math.random() * 200;

            if (rand < 0.2) {
                const chainWidth = 350 + Math.random() * 150;
                platforms.push({ x: nextX, y: 300, width: 60, height: 30, type: 'platform' });
                platforms.push({ 
                      x: nextX + 60, y: 280, width: chainWidth, height: 20, 
                      type: 'chain_conveyor', bladeOffset: 0, 
                      bladeSpeed: 0.8 + Math.random() * 0.4 
                  });
                platforms.push({ x: nextX + 60 + chainWidth, y: 300, width: 120, height: 30, type: 'platform' });
                lastGeneratedX = nextX + chainWidth + 180;
            } else if (rand < 0.4) {
                const chasmWidth = 550;
                platforms.push({ x: nextX, y: 300, width: 80, height: 30, type: 'platform' });
                vines.push({ x: nextX + 60, y: 80, height: 220 });
                ziplines.push({ x1: nextX + 60, y1: 100, x2: nextX + 60 + chasmWidth, y2: 240 });
                platforms.push({ x: nextX + chasmWidth + 10, y: 300, width: 150, height: 30, type: 'platform' });
                lastGeneratedX = nextX + chasmWidth + 160;
            } else {
                platforms.push({ x: nextX, y: nextY, width: width, height: 30, type: 'platform' });
                
                if (Math.random() < 0.4 && width > 160) {
                    platforms.push({
                        x: nextX + width/2 - 40,
                        y: nextY - 45,
                        width: 80,
                        height: 45,
                        type: 'arch'
                    });
                } else {
                    let eRand = Math.random();
                    if (eRand < 0.2) { enemies.push({ type: 'bird', x: nextX + width + 200, y: nextY - 80 - Math.random() * 60, width: 40, height: 30, speed: 1.5, dir: -1, hp: 1 }); }
                    else if (eRand < 0.4) { enemies.push({ type: 'worm', x: nextX + 30, y: nextY - 20, width: 40, height: 20, speed: 0.8, dir: 1, startX: nextX, endX: nextX + width, hp: 1 }); }
                    else if (eRand < 0.6) { enemies.push({ type: 'bug', x: nextX + 80, y: nextY - 40, width: 50, height: 40, speed: 1, dir: 1, startX: nextX, endX: nextX + width, hp: 2 }); }
                    else if (eRand < 0.85) { 
                        enemies.push({ 
                             type: 'frog', x: nextX + width/2 - 20, y: nextY - 35, width: 40, height: 35, 
                             hp: 1, dir: -1, tongueState: 'idle', tongueLen: 0, timer: 0 
                         }); 
                    }
                    else { enemies.push({ type: 'spikes', x: nextX + 110, y: nextY - 45, width: 40, height: 45 }); }
                }
                lastGeneratedX = nextX + width;
            }

            // --- SPAWN ITEMS TAI VI TRI KHO ---
            if (Math.random() < 0.3) { 
                // Them vat pham speed va time_x2
                let types = ['spring', 'star', 'gun', 'speed', 'time_x2'];
                let type = types[Math.floor(Math.random() * types.length)];
                let ix, iy;
                let rPos = Math.random();
                
                if (rPos < 0.33) {
                    ix = nextX + width / 2;
                    iy = nextY - 160 - Math.random() * 40; 
                } else if (rPos < 0.66) {
                    ix = nextX + width - 10;
                    iy = nextY - 30;
                } else {
                    ix = nextX - 50; 
                    iy = nextY + 30; 
                }
                items.push({ x: ix, y: iy, width: 20, height: 20, type: type, baseY: iy });
            }
        }

        function update() {
            if (gameState !== 'PLAYING') return;

            // --- UPDATE TIMERS VAT PHAM ---
            if (player.highJumpTimer > 0) {
                player.highJumpTimer--;
                player.jumpForce = 16;
            } else {
                player.jumpForce = player.baseJumpForce;
            }

            if (player.invincibleTimer > 0) {
                player.invincibleTimer--;
            }

            if (player.speedTimer > 0) {
                player.speedTimer--;
                player.speed = player.baseSpeed * 1.6; // Chay nhanh hon
            } else {
                player.speed = player.baseSpeed;
            }

            if (player.gunTimer > 0) {
                player.gunTimer--;
            }

            // --- KIEM TRA AN VAT PHAM ---
            for (let i = items.length - 1; i >= 0; i--) {
                let it = items[i];
                if (player.x < it.x + it.width && player.x + player.width > it.x &&
                    player.y < it.y + it.height && player.y + player.height > it.y) {
                    
                    if (it.type === 'spring') { 
                        player.highJumpTimer = 1200; player.highJumpMax = 1200; showMessage("HIGH JUMP!"); 
                    }
                    else if (it.type === 'star') { 
                        player.invincibleTimer = 1200; player.invincibleMax = 1200; showMessage("INVINCIBLE!"); 
                    }
                    else if (it.type === 'gun') { 
                        player.gunTimer = 1200; player.gunMax = 1200; showMessage("AUTO GUN!"); 
                    }
                    else if (it.type === 'speed') { 
                        player.speedTimer = 1200; player.speedMax = 1200; showMessage("SPEED UP!"); 
                    }
                    else if (it.type === 'time_x2') {
                        // Nhan doi thoi gian vat pham dang hoat dong va tang limit max de hien thi pie chart dung
                        if (player.highJumpTimer > 0) { player.highJumpTimer *= 2; player.highJumpMax = Math.max(player.highJumpMax, player.highJumpTimer); }
                        if (player.invincibleTimer > 0) { player.invincibleTimer *= 2; player.invincibleMax = Math.max(player.invincibleMax, player.invincibleTimer); }
                        if (player.gunTimer > 0) { player.gunTimer *= 2; player.gunMax = Math.max(player.gunMax, player.gunTimer); }
                        if (player.speedTimer > 0) { player.speedTimer *= 2; player.speedMax = Math.max(player.speedMax, player.speedTimer); }
                        showMessage("TIME x2!");
                    }
                    
                    playItemSound(); // Phat tieng an item
                    createParticles(it.x + 10, it.y + 10, '#fff', 15);
                    items.splice(i, 1);
                }
            }

            // --- SUNG TU DONG BAN (Dung timer thay vi dan) ---
            if (player.gunTimer > 0 && player.frameCount % 20 === 0) {
                let target = null;
                let minDist = 400; // Tam ban
                for (let e of enemies) {
                    if (e.type !== 'spikes' && e.type !== 'arch' && e.x > player.x && e.x - player.x < minDist) {
                        minDist = e.x - player.x;
                        target = e;
                    }
                }
                if (target) {
                    let dx = (target.x + target.width/2) - (player.x + player.width/2);
                    let dy = (target.y + target.height/2) - (player.y + player.height/2);
                    let mag = Math.sqrt(dx*dx + dy*dy);
                    bullets.push({
                        x: player.x + player.width/2,
                        y: player.y + player.height/2,
                        vx: (dx/mag) * 10,
                        vy: (dy/mag) * 10,
                        life: 80
                    });
                    
                    playShootSound(); // Phat tieng ban sung
                    createParticles(player.x + player.width/2, player.y + 10, '#f44336', 3);
                    // Da xoa dong tru dan (player.gunAmmo--)
                }
            }

            // --- UPDATE DAN ---
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i];
                b.x += b.vx;
                b.y += b.vy;
                b.life--;
                let hit = false;

                for (let j = enemies.length - 1; j >= 0; j--) {
                    let e = enemies[j];
                    if (e.type !== 'spikes' && e.type !== 'arch' && b.x > e.x && b.x < e.x + e.width && b.y > e.y && b.y < e.y + e.height) {
                        if (e.hp > 1) {
                            e.hp--;
                        } else {
                            enemies.splice(j, 1);
                        }
                        playHitEnemySound(); // Am thanh trung quai
                        createParticles(e.x + e.width/2, e.y + e.height/2, '#f44336', 10);
                        hit = true;
                        break;
                    }
                }
                if (hit || b.life <= 0) {
                    bullets.splice(i, 1);
                }
            }

            // Background clouds
            clouds.forEach(c => { 
                c.x -= c.speed; 
                if (c.x + c.size * 2 < 0) { 
                    c.x = canvas.width + 50; 
                    c.y = Math.random() * 150 + 20; 
                } 
            });

            let currentDist = (player.x - 100) / 20;
            if (currentDist > score) score = currentDist;
            updateScoreUI();

            let onVine = null;
            for (let v of vines) {
                if (player.x + player.width > v.x - 15 && player.x < v.x + 15 && 
                    player.y + player.height > v.y && player.y < v.y + v.height) {
                    onVine = v; break;
                }
            }
            if (onVine && (keys['ArrowUp'] || keys['ArrowDown'])) {
                player.isClimbing = true; player.isZipping = false; player.velY = 0;
                player.x = onVine.x - player.width/2;
            } else if (!onVine) { player.isClimbing = false; }

            if (!player.isZipping) {
                for (let z of ziplines) {
                    let d = Math.abs((z.y2 - z.y1) * player.x - (z.x2 - z.x1) * player.y + z.x2 * z.y1 - z.y2 * z.x1) / Math.sqrt(Math.pow(z.y2 - z.y1, 2) + Math.pow(z.x2 - z.x1, 2));
                    if (d < 30 && player.x > z.x1 && player.x < z.x2 && player.velY > -3) {
                        player.isZipping = true; player.isClimbing = false; player.grounded = false; break;
                    }
                }
            }

            if (player.isClimbing) {
                if (keys['ArrowUp']) player.y -= 3;
                if (keys['ArrowDown']) player.y += 3;
                if (keys['Space'] || keys['ArrowLeft'] || keys['ArrowRight']) {
                    player.isClimbing = false; 
                    if (keys['Space']) {
                        player.velY = -player.jumpForce;
                        playJumpSound(); // Phat tieng nhay tu day leo
                    }
                }
            } else if (player.isZipping) {
                player.velY = 0; player.x += 3; player.dir = 1;
                let fz = false;
                for (let z of ziplines) {
                    if (player.x >= z.x1 && player.x <= z.x2) {
                        let t = (player.x - z.x1) / (z.x2 - z.x1);
                        player.y = z.y1 + t * (z.y2 - z.y1) + 20; 
                        fz = true; break;
                    }
                }
                if (!fz) { player.isZipping = false; player.velY = 2; }
                if (keys['Space'] || keys['ArrowDown']) player.isZipping = false;
            } else {
                if (keys['ArrowLeft']) { player.velX = -player.speed; player.dir = -1; }
                else if (keys['ArrowRight']) { player.velX = player.speed; player.dir = 1; }
                else player.velX = 0;

                // Xu ly ngoi
                if (keys['ArrowDown']) {
                    if (!player.isDucking) { player.isDucking = true; player.height = 25; player.y += 20; }
                } else {
                    if (player.isDucking) { player.isDucking = false; player.height = 45; player.y -= 20; }
                }

                if ((keys['ArrowUp'] || keys['KeyW'] || keys['Space']) && player.grounded) {
                    player.velY = -player.jumpForce; player.grounded = false; player.canDoubleJump = true;
                    keys['ArrowUp'] = keys['KeyW'] = keys['Space'] = false;
                    playJumpSound(); // Phat tieng nhay
                } else if ((keys['ArrowUp'] || keys['KeyW'] || keys['Space']) && player.canDoubleJump) {
                    player.velY = -player.jumpForce * 0.8; player.canDoubleJump = false;
                    createParticles(player.x + player.width/2, player.y + player.height, '#333', 5);
                    keys['ArrowUp'] = keys['KeyW'] = keys['Space'] = false;
                    playJumpSound(); // Phat tieng nhay buoc 2
                }
                player.velY += 0.5; player.x += player.velX; player.y += player.velY;
            }

            if (player.x < cameraX) player.x = cameraX;
            let targetCameraX = player.x - 250;
            if (targetCameraX > cameraX) cameraX = targetCameraX;

            if (!player.isClimbing && !player.isZipping) {
                player.grounded = false;
                for (let p of platforms) {
                    if (p.type === 'chain_conveyor') {
                        p.bladeOffset = (p.bladeOffset + p.bladeSpeed) % 200;
                        if (player.x < p.x + p.width && player.x + player.width > p.x && player.y + player.height >= p.y && player.y + player.height <= p.y + 20 && player.velY >= 0) {
                            player.y = p.y - player.height; player.velY = 0; player.grounded = true; player.canDoubleJump = true;
                            for (let i = -1; i < p.width / 100 + 1; i++) {
                                let bx = p.x + (i * 200) + p.bladeOffset;
                                if (bx > p.x && bx < p.x + p.width && Math.abs((player.x + player.width/2) - bx) < 25) {
                                    if (player.invincibleTimer <= 0) endGame(); // Tang hinh bo qua
                                }
                            }
                        }
                    } else if (p.type === 'arch') {
                        if (player.x + player.width > p.x && player.x < p.x + p.width) {
                            if (!player.isDucking || player.y < p.y - 2) {
                                if (player.invincibleTimer <= 0) { // Tang hinh bo qua
                                    endGame();
                                    showMessage("Hit the roof!");
                                    return;
                                }
                            }
                        }
                    } else if (player.x < p.x + p.width && player.x + player.width > p.x && player.y < p.y + p.height && player.y + player.height > p.y) {
                        if (player.velY > 0 && player.y + player.height - player.velY <= p.y + 10) { player.y = p.y - player.height; player.velY = 0; player.grounded = true; player.canDoubleJump = true; }
                    }
                }
            }

            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                if (e.type !== 'spikes') {
                    if (e.type === 'worm') {
                        const wc = (player.frameCount * 0.1) % (Math.PI * 2);
                        if (wc < Math.PI) e.x += e.speed * e.dir * 1.5;
                    } else if (e.type === 'frog') {
                        if (player.x < e.x) e.dir = -1; else e.dir = 1; 
                        
                        if (e.tongueState === 'idle') {
                            if (Math.random() < 0.003) {
                                e.tongueState = 'shooting';
                            }
                        } else if (e.tongueState === 'shooting') {
                            e.tongueLen += 15;
                            if (e.tongueLen > 90) e.tongueState = 'retracting';
                            let tX = (e.dir === 1) ? e.x + 30 : e.x + 10 - e.tongueLen;
                            let tY = e.y + 15;
                            let tW = e.tongueLen;
                            let tH = 8;
                            if (player.x < tX + tW && player.x + player.width > tX &&
                                player.y < tY + tH && player.y + player.height > tY) {
                                if (player.invincibleTimer <= 0) endGame(); // Tang hinh bo qua
                            }

                        } else if (e.tongueState === 'retracting') {
                            e.tongueLen -= 15;
                            if (e.tongueLen <= 0) {
                                e.tongueLen = 0;
                                e.tongueState = 'idle';
                            }
                        }
                    } else { e.x += (e.speed || 0) * (e.dir || 1); }

                    if (e.type === 'bird') { if (e.x < cameraX - 200 || e.x > cameraX + 1200) e.dir *= -1; }
                    else if (e.type !== 'frog') { if (e.x < e.startX || e.x + e.width > e.endX) e.dir *= -1; }
                }

                if (player.x < e.x + e.width && player.x + player.width > e.x && player.y < e.y + e.height && player.y + player.height > e.y) {
                    const playerFeet = player.y + player.height;
                    const enemyMiddle = e.y + e.height * 0.7;
                    
                    if (player.invincibleTimer > 0) {
                        // TANG HINH: Pha huy ke dich ngay lap tuc
                        if (e.type !== 'spikes' && e.type !== 'arch') {
                            playHitEnemySound(); // Am thanh dap quai khi tang hinh
                            enemies.splice(i, 1);
                            createParticles(e.x + e.width/2, e.y + e.height/2, '#fff', 15);
                        }
                    } else if (player.velY > 0 && playerFeet <= enemyMiddle + 15 && e.type !== 'spikes' && e.type !== 'bird') {
                        // Giam quai binh thuong
                        playHitEnemySound(); // Am thanh dap quai
                        createParticles(e.x + e.width/2, e.y + e.height, '#333', 12);
                        if (e.type === 'bug' && e.hp > 1) { 
                            e.hp--; player.velY = -player.jumpForce * 0.7; createParticles(e.x + 25, e.y, '#333', 5);
                        } else { 
                            enemies.splice(i, 1); player.velY = -player.jumpForce * 0.7;
                        }
                    } else { 
                        endGame(); 
                    }
                }
            }

            if (player.x + canvas.width > lastGeneratedX) spawnNextChunk();
            if (player.y > canvas.height + 150) endGame(); // Roi xuong vuc van chet ngay ca khi tang hinh
            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.alpha -= 0.02; if (p.alpha <= 0) particles.splice(i, 1); });
            player.frameCount++;

            // Cleanup
            if (player.frameCount % 60 === 0) {
                const cleanupThreshold = cameraX - 200;
                platforms = platforms.filter(p => p.x + p.width > cleanupThreshold);
                enemies = enemies.filter(e => e.x + e.width > cleanupThreshold);
                vines = vines.filter(v => v.x + 20 > cleanupThreshold);
                ziplines = ziplines.filter(z => Math.max(z.x1, z.x2) > cleanupThreshold);
                items = items.filter(it => it.x + it.width > cleanupThreshold);
            }
        }

        function endGame() {
             if (gameState === 'GAMEOVER') return; // Chi play am thanh 1 lan
             playGameOverSound();
             gameState = 'GAMEOVER';
             gameOverScreen.classList.add('active');
             finalScoreElement.innerText = "Score: " + Math.floor(score) + " | Best: " + Math.floor(bestScore);
             touchZonesContainer.style.display = 'none';
        }

        function createParticles(x, y, color, count) { for (let i = 0; i < count; i++) { particles.push({ x, y, vx: (Math.random() - 0.5) * 6, vy: (Math.random() - 0.5) * 6, alpha: 1, color }); } }

        function drawHatching(ctx, x, y, w, h, spacing = 10) {
            ctx.save();
            ctx.beginPath();
            ctx.rect(x, y, w, h);
            ctx.clip();
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            for (let i = x - h; i < x + w; i += spacing) {
                ctx.beginPath();
                ctx.moveTo(i, y + h);
                ctx.lineTo(i + h, y);
                ctx.stroke();
            }
            ctx.restore();
        }

        function drawEnemy(ctx, e, frameCount) {
            ctx.save();
            setDoodleStyle(ctx);

            if (e.type === 'worm') {
                const wc = (frameCount * 0.1) % (Math.PI * 2);
                const ah = Math.max(0, Math.sin(wc) * 15);
                const bl = 40 - (ah * 0.5);
                ctx.lineWidth = 2;
                for(let i=0; i<5; i++) {
                    let dx = e.x + (i * bl / 4); let dy = e.y + 15;
                    if (i > 0 && i < 4) dy -= ah * (1 - Math.abs(2-i)*0.5);
                    ctx.fillStyle = '#ccff90';
                    ctx.beginPath(); ctx.arc(dx, dy, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.beginPath(); ctx.arc(dx, dy, 1.5, 0, Math.PI * 2); ctx.fill();

                    if ((e.dir > 0 && i === 4) || (e.dir < 0 && i === 0)) {
                        ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(dx + 2*e.dir, dy - 2, 3, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(dx + 3*e.dir, dy - 2, 1, 0, Math.PI * 2); ctx.fill();
                    }
                }
            } else if (e.type === 'bug') {
                const mo = Math.abs(Math.sin(frameCount * 0.15)) * 0.7;
                ctx.fillStyle = '#e1bee7';
                ctx.beginPath(); ctx.moveTo(e.x + 25, e.y + 20);
                let sa = (e.dir > 0) ? mo : Math.PI + mo;
                let ea = (e.dir > 0) ? Math.PI * 2 - mo : Math.PI - mo;
                ctx.arc(e.x + 25, e.y + 20, 20, sa, ea); 
                ctx.closePath(); 
                ctx.fill(); ctx.stroke();

                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(e.x + 25 + 5 * e.dir, e.y + 5, 7, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(e.x + 25 + 7 * e.dir, e.y + 5, 3, 0, Math.PI * 2); ctx.fill();

                if (mo > 0.1) {
                    ctx.fillStyle = 'white';
                    for(let i=0; i<2; i++) {
                        let ta = (e.dir > 0) ? (i === 0 ? mo : -mo) : (i === 0 ? Math.PI - mo : Math.PI + mo);
                        let tx = e.x + 25 + Math.cos(ta) * 18; let ty = e.y + 20 + Math.sin(ta) * 18;
                        ctx.beginPath(); ctx.moveTo(tx, ty); ctx.lineTo(tx - 6 * e.dir, ty - 4); ctx.lineTo(tx - 6 * e.dir, ty + 4); ctx.fill(); ctx.stroke();
                    }
                }
                if (e.hp > 1) { ctx.fillStyle = '#333'; ctx.fillRect(e.x + 5, e.y - 15, 40, 4); }
            } else if (e.type === 'bird') {
                ctx.save();
                ctx.translate(e.x + 20, e.y + 15);
                ctx.scale(e.dir, 1);
                ctx.fillStyle = '#81d4fa'; 
                ctx.beginPath(); ctx.ellipse(0, 0, 18, 12, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(12, -3, 2, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#ffcc80'; 
                ctx.beginPath(); ctx.moveTo(18, -3); ctx.lineTo(28, 0); ctx.lineTo(18, 3); ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#b3e5fc';
                let wa = Math.sin(frameCount * 0.1) * 20;
                ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-25, -wa); ctx.lineTo(-10, 10); ctx.fill(); ctx.stroke();
                ctx.restore();
            } else if (e.type === 'frog') {
                ctx.translate(e.x + 20, e.y + 17);
                ctx.scale(e.dir, 1);
                let breathe = 1 + Math.sin(frameCount * 0.1) * 0.05;
                ctx.scale(1, breathe);
                ctx.fillStyle = '#a5d6a7'; 
                ctx.beginPath(); ctx.ellipse(0, 0, 20, 15, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                ctx.beginPath(); ctx.ellipse(-15, 5, 10, 8, 0.5, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                let isBlinking = (frameCount % 120 < 10);
                if (isBlinking) {
                    ctx.beginPath(); ctx.moveTo(5, -12); ctx.lineTo(15, -12); ctx.stroke();
                } else {
                    ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(10, -12, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(12, -12, 2, 0, Math.PI * 2); ctx.fill();
                }
                if (e.tongueLen > 0) {
                    ctx.fillStyle = '#ef9a9a';
                    ctx.beginPath(); ctx.rect(10, 0, e.tongueLen, 6); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(10 + e.tongueLen, 3, 3, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                }
            } else if (e.type === 'spikes') {
                ctx.fillStyle = '#b0bec5';
                ctx.beginPath(); ctx.rect(e.x + 15, e.y + 5, 10, 40); ctx.fill(); ctx.stroke();
                ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(e.x + 15, e.y + 25); ctx.lineTo(e.x + 5, e.y + 25); ctx.lineTo(e.x + 5, e.y + 15); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(e.x + 25, e.y + 15); ctx.lineTo(e.x + 35, e.y + 15); ctx.lineTo(e.x + 35, e.y + 5); ctx.stroke();
                ctx.fillStyle = '#333'; for(let k=0; k<5; k++) { ctx.fillRect(e.x + 18, e.y + 5 + k*8, 2, 2); }
            }
            ctx.restore();
        }

        // --- CAC HAM VE ICON VAT PHAM DE TAI SU DUNG TREN MAP VA PIE CHART ---
        function drawGunIcon(ctx) {
            ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5; ctx.lineJoin = 'round';
            // Tay cam
            ctx.fillStyle = '#5d4037';
            ctx.beginPath(); ctx.moveTo(-6, 2); ctx.lineTo(-10, 10); ctx.lineTo(-4, 12); ctx.lineTo(0, 2); ctx.closePath(); ctx.fill(); ctx.stroke();
            // Than sung
            ctx.fillStyle = '#29b6f6'; 
            ctx.beginPath(); ctx.ellipse(2, -2, 10, 5, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            // Nong sung
            ctx.fillStyle = '#ffca28'; 
            ctx.beginPath(); ctx.rect(10, -5, 6, 6); ctx.fill(); ctx.stroke();
            // Dau nong sung
            ctx.fillStyle = '#f44336'; 
            ctx.beginPath(); ctx.arc(17, -2, 3, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            // Chi tiet
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(2, -2, 2, 0, Math.PI*2); ctx.fill();
        }

        function drawSpringIcon(ctx) {
            ctx.strokeStyle = '#2196f3'; ctx.lineWidth = 3;
            ctx.lineCap = 'round'; ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(-6, 8); ctx.lineTo(6, 4); ctx.lineTo(-6, -1); ctx.lineTo(6, -5); ctx.lineTo(-6, -10);
            ctx.stroke();
        }

        function drawStarIcon(ctx) {
            ctx.fillStyle = '#ffeb3b'; ctx.strokeStyle = '#fbc02d'; ctx.lineWidth = 1;
            ctx.beginPath();
            for(let i=0; i<5; i++) {
                ctx.lineTo(Math.cos((18+i*72)*Math.PI/180)*12, -Math.sin((18+i*72)*Math.PI/180)*12);
                ctx.lineTo(Math.cos((54+i*72)*Math.PI/180)*5, -Math.sin((54+i*72)*Math.PI/180)*5);
            }
            ctx.closePath(); ctx.fill(); ctx.stroke();
        }

        function drawSpeedIcon(ctx) {
            ctx.fillStyle = '#00e5ff'; ctx.strokeStyle = '#00b8d4'; ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(2, -10); ctx.lineTo(-6, 2); ctx.lineTo(-1, 2); ctx.lineTo(-4, 10); ctx.lineTo(6, -2); ctx.lineTo(1, -2); ctx.closePath();
            ctx.fill(); ctx.stroke();
        }

        function drawTimeX2Icon(ctx) {
            // Ve dong ho cat lech ve trai mot chut
            ctx.save();
            ctx.translate(-5, 0);
            ctx.fillStyle = '#bcaaa4'; ctx.strokeStyle = '#5d4037'; ctx.lineWidth = 1.5;
            ctx.beginPath();
            ctx.moveTo(-5, -6); ctx.lineTo(5, -6); ctx.lineTo(1, 0); ctx.lineTo(5, 6); ctx.lineTo(-5, 6); ctx.lineTo(-1, 0); ctx.closePath();
            ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#ffcc80';
            ctx.beginPath(); ctx.moveTo(-3, -4); ctx.lineTo(3, -4); ctx.lineTo(0, -1); ctx.fill();
            ctx.beginPath(); ctx.moveTo(-2, 4); ctx.lineTo(2, 4); ctx.lineTo(0, 1); ctx.fill();
            ctx.restore();
            // Ve chu x2 ben phai
            ctx.fillStyle = '#d32f2f'; ctx.font = 'bold 14px "Patrick Hand", cursive';
            ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
            ctx.fillText('x2', 2, 0);
        }

        // --- VE VAT PHAM TREN BAN DO ---
        function drawItem(ctx, item) {
            ctx.save();
            let iy = item.baseY + Math.sin(player.frameCount * 0.1) * 5; // Hieu ung bay lo lung
            ctx.translate(item.x + 10, iy + 10);
            
            // Ve hao quang
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
            ctx.lineWidth = 4;
            ctx.beginPath(); ctx.arc(0, 0, 16 + Math.sin(player.frameCount*0.2)*2, 0, Math.PI*2); ctx.stroke();

            if (item.type === 'spring') drawSpringIcon(ctx);
            else if (item.type === 'star') drawStarIcon(ctx);
            else if (item.type === 'gun') { ctx.save(); drawGunIcon(ctx); ctx.restore(); }
            else if (item.type === 'speed') drawSpeedIcon(ctx);
            else if (item.type === 'time_x2') drawTimeX2Icon(ctx);

            ctx.restore();
        }

        function drawPlayer(ctx, p) {
            ctx.save(); 
            // Hieu ung nhap nhay khi tang hinh
            if (p.invincibleTimer > 0 && Math.floor(p.frameCount / 5) % 2 === 0) {
                ctx.globalAlpha = 0.4;
            }
            
            ctx.translate(p.x + p.width/2, p.y + 12); 
            ctx.scale(-p.dir, 1);
            setDoodleStyle(ctx);

            let br = Math.sin(p.frameCount * 0.1) * 1.5;
            if (p.velX !== 0 || !p.grounded || p.isClimbing || p.isZipping) br = 0;
            const bodyH = p.isDucking ? 15 : 25;

            // Tay
            for(let side of [-1, 1]) {
                ctx.save(); let lx = side * 7; let ly = bodyH + 2;
                if (p.isZipping) { lx += Math.sin(p.frameCount * 0.1) * 8; ly -= 2; }
                else if (p.velX !== 0) { lx += Math.sin(p.frameCount * 0.2 + (side===1?0:Math.PI)) * 8; ly += Math.abs(Math.cos(p.frameCount * 0.2 + (side===1?0:Math.PI))) * 4; }
                
                ctx.fillStyle = '#333'; ctx.beginPath(); ctx.arc(lx, ly, 6, 0, Math.PI * 2); ctx.fill(); ctx.restore();
            }

            // Body
            if (p.isZipping || p.isClimbing) {
                const hc = Math.sin(p.frameCount * 0.15); 
                for(let side of [-1, 1]) {
                    let hY = -25 + (side===1 ? (hc < 0 ? -hc * 15 : 0) : (hc > 0 ? hc * 15 : 0));
                    ctx.beginPath(); ctx.moveTo(side*5, 5); ctx.lineTo(side*12, hY); ctx.stroke();
                    ctx.fillStyle = '#ffe0b2'; ctx.beginPath(); ctx.arc(side*12, hY, 5, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                }
            } else {
                let aa = (p.velX !== 0 && p.grounded) ? Math.sin(p.frameCount * 0.2) * 0.6 : 0;
                ctx.save(); ctx.translate(0, 5);
                // Chan trai
                ctx.save(); ctx.rotate(-aa); 
                ctx.fillStyle = '#90caf9'; ctx.beginPath(); ctx.rect(-14, 0, 6, 18); ctx.fill(); ctx.stroke();
                // Hieu ung giay lo xo khi co high jump
                if (p.highJumpTimer > 0) { ctx.strokeStyle = '#2196f3'; ctx.beginPath(); ctx.moveTo(-11, 18); ctx.lineTo(-14, 22); ctx.lineTo(-8, 26); ctx.stroke(); }
                ctx.restore();
                
                // Chan phai
                ctx.save(); ctx.rotate(aa); 
                ctx.fillStyle = '#64b5f6'; ctx.beginPath(); ctx.rect(8, 0, 6, 18); ctx.fill(); ctx.stroke();
                if (p.highJumpTimer > 0) { ctx.strokeStyle = '#2196f3'; ctx.beginPath(); ctx.moveTo(11, 18); ctx.lineTo(8, 22); ctx.lineTo(14, 26); ctx.stroke(); }
                ctx.restore();
                ctx.restore();
            }

            // Than
            ctx.fillStyle = '#42a5f5'; 
            ctx.beginPath(); ctx.rect(-10, br, 20, bodyH); ctx.fill(); ctx.stroke();

            // Dau
            ctx.translate(0, br); 
            ctx.fillStyle = '#ffe0b2';
            ctx.beginPath(); ctx.arc(0, -2, 12, 0, Math.PI * 2); ctx.fill(); ctx.stroke();

            // Mat
            ctx.fillStyle = '#333'; 
            ctx.beginPath(); ctx.arc(-4, -4, 2, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(-8, -4, 2, 0, Math.PI * 2); ctx.fill();

            // Mu
            ctx.fillStyle = '#ef5350'; 
            ctx.beginPath(); ctx.arc(0, -7, 15, Math.PI, 0); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.rect(-15, -10, 30, 4); ctx.fill(); ctx.stroke();

            ctx.restore();
        }

        function drawBrickStructure(ctx, x, y, w, h) {
            ctx.save();
            setDoodleStyle(ctx);
            ctx.fillStyle = '#fff';
            ctx.fillRect(x, y, w, h);
            drawHatching(ctx, x, y, w, h);
            ctx.strokeRect(x, y, w, h);

            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            const bW = 20; const bH = 10;
            ctx.beginPath();
            for(let j = 0; j < h; j += bH) {
                ctx.moveTo(x, y + j); ctx.lineTo(x + w, y + j);
                let offset = (j / bH) % 2 === 0 ? 0 : bW / 2;
                for(let i = offset; i < w; i += bW) {
                    if (x+i < x+w) { 
                        ctx.moveTo(x + i, y + j); ctx.lineTo(x + i, y + j + bH);
                    }
                }
            }
            ctx.stroke();
            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            setDoodleStyle(ctx);

            // SUN
            ctx.fillStyle = '#fff176'; 
            ctx.beginPath(); ctx.arc(700, 60, 25, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
            // Tia nang
            ctx.beginPath();
            for(let i=0; i<8; i++) {
                let ang = (i/8)*Math.PI*2;
                ctx.moveTo(700 + Math.cos(ang)*30, 60 + Math.sin(ang)*30);
                ctx.lineTo(700 + Math.cos(ang)*45, 60 + Math.sin(ang)*45);
            }
            ctx.stroke();

            // CLOUDS
            ctx.save();
            ctx.globalAlpha = 0.6;
            clouds.forEach(c => { 
                ctx.fillStyle = '#fff'; 
                ctx.beginPath(); ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2); ctx.fill();
            });
            ctx.restore();

            ctx.save(); ctx.translate(-cameraX, 0);
            
            // VINES
            vines.forEach(v => {
                ctx.save(); 
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; 
                ctx.beginPath();
                ctx.moveTo(v.x, v.y);
                for(let i=0; i<=v.height; i+=20) { 
                    ctx.lineTo(v.x + Math.sin(i*0.1)*5, v.y + i);
                }
                ctx.stroke();
                ctx.fillStyle = '#a5d6a7'; 
                for(let i=0; i<v.height; i+=30) { 
                    ctx.beginPath(); ctx.arc(v.x + 5, v.y + i, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(v.x - 5, v.y + i + 15, 6, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                }
                ctx.restore();
            });
            
            // ZIPLINES
            ziplines.forEach(z => {
                ctx.save(); 
                ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]); 
                ctx.beginPath(); ctx.moveTo(z.x1, z.y1); ctx.lineTo(z.x2, z.y2); ctx.stroke();
                ctx.setLineDash([]); 
                ctx.fillStyle = '#fff'; 
                ctx.fillRect(z.x1-5, z.y1-10, 10, 20); ctx.strokeRect(z.x1-5, z.y1-10, 10, 20);
                ctx.fillRect(z.x2-5, z.y2-10, 10, 20); ctx.strokeRect(z.x2-5, z.y2-10, 10, 20);
                ctx.restore();
            });

            platforms.forEach(p => {
                if (p.type === 'chain_conveyor') {
                    ctx.save();
                    ctx.strokeStyle = '#333'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(p.x, p.y + 10); ctx.lineTo(p.x + p.width, p.y + 10); ctx.stroke();
                    ctx.fillStyle = '#fff'; 
                    for(let x = p.x; x < p.x + p.width; x += 15) { ctx.beginPath(); ctx.arc(x, p.y + 10, 4, 0, Math.PI * 2); ctx.fill(); ctx.stroke(); }
                    ctx.fillStyle = '#ff8a80'; 
                    for (let i = -1; i < p.width / 100 + 1; i++) {
                        let bx = p.x + (i * 200) + p.bladeOffset; if (bx > p.x && bx < p.x + p.width) {
                            ctx.save(); ctx.translate(bx, p.y + 5); ctx.rotate(Date.now() / 100); ctx.beginPath();
                            for (let a = 0; a < 4; a++) { let ang = (a/4)*Math.PI*2; ctx.lineTo(Math.cos(ang)*15, Math.sin(ang)*15); ctx.lineTo(Math.cos(ang+0.5)*5, Math.sin(ang+0.5)*5); }
                            ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
                        }
                    } ctx.restore();
                } else if (p.type === 'arch') {
                    drawBrickStructure(ctx, p.x, p.y, 12, p.height);
                    drawBrickStructure(ctx, p.x + p.width - 12, p.y, 12, p.height);
                    drawBrickStructure(ctx, p.x, p.y - 15, p.width, 15);
                    
                    // KING KONG
                    ctx.save();
                    const kX = p.x + p.width / 2;
                    const kY = p.y - 15;
                    const breathe = Math.sin(Date.now() / 200) * 4;
                    // Body
                    ctx.fillStyle = '#8d6e63';
                    ctx.beginPath(); ctx.ellipse(kX, kY - 35, 55 + breathe, 45 + breathe/2, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    // Chest
                    ctx.fillStyle = '#d7ccc8'; 
                    ctx.beginPath(); ctx.ellipse(kX, kY - 30, 35 + breathe * 0.8, 28 + breathe * 0.5, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    // Arms
                    ctx.fillStyle = '#8d6e63';
                    ctx.beginPath(); ctx.ellipse(kX - 58 - breathe/2, kY - 25, 20, 35, 0.2, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.ellipse(kX + 58 + breathe/2, kY - 25, 20, 35, -0.2, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    // Head
                    ctx.fillStyle = '#8d6e63';
                    ctx.beginPath(); ctx.ellipse(kX, kY - 78, 32, 26, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    // Ears
                    ctx.beginPath(); ctx.arc(kX - 30, kY - 84, 9, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(kX + 30, kY - 84, 9, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    // Face
                    ctx.fillStyle = '#d7ccc8';
                    ctx.beginPath(); ctx.ellipse(kX, kY - 74, 24, 16, 0, 0, Math.PI * 2); ctx.fill(); ctx.stroke();
                    // Eyes
                    ctx.fillStyle = 'white';
                    ctx.beginPath(); ctx.arc(kX - 10, kY - 86, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.beginPath(); ctx.arc(kX + 10, kY - 86, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = 'black';
                    ctx.beginPath(); ctx.arc(kX - 10, kY - 86, 2, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(kX + 10, kY - 86, 2, 0, Math.PI*2); ctx.fill();
                    // Nostrils
                    ctx.beginPath(); ctx.arc(kX - 4, kY - 72, 1, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.arc(kX + 4, kY - 72, 1, 0, Math.PI*2); ctx.fill();
                    ctx.restore();
                } else { 
                    // Ground
                    ctx.save();
                    ctx.fillStyle = '#fff';
                    ctx.beginPath(); ctx.rect(p.x, p.y, p.width, p.height); ctx.fill();
                    drawHatching(ctx, p.x, p.y, p.width, p.height);
                    ctx.strokeRect(p.x, p.y, p.width, p.height);
                    ctx.restore();
                }
            });

            // Ve vat pham tren ban do
            for (let item of items) drawItem(ctx, item);

            for (let e of enemies) drawEnemy(ctx, e, player.frameCount);
            
            // Ve dan sung
            for (let b of bullets) {
                ctx.fillStyle = '#ff5722'; ctx.strokeStyle = '#333';
                ctx.beginPath(); ctx.arc(b.x, b.y, 4, 0, Math.PI*2); ctx.fill(); ctx.stroke();
            }

            particles.forEach(p => { 
                ctx.globalAlpha = p.alpha; ctx.fillStyle = p.color; 
                ctx.beginPath(); ctx.rect(p.x, p.y, 4, 4); ctx.fill(); 
            }); 
            
            ctx.globalAlpha = 1; 
            drawPlayer(ctx, player);

            ctx.restore(); // ket thuc translate camera

            // --- HIEN THI TIMERS (VONG TRON HINH QUAT) á»ž GIUA DUOI MAN HINH ---
            let activeItems = [];
            if (player.highJumpTimer > 0) activeItems.push({type: 'spring', timer: player.highJumpTimer, max: player.highJumpMax});
            if (player.invincibleTimer > 0) activeItems.push({type: 'star', timer: player.invincibleTimer, max: player.invincibleMax});
            if (player.gunTimer > 0) activeItems.push({type: 'gun', timer: player.gunTimer, max: player.gunMax});
            if (player.speedTimer > 0) activeItems.push({type: 'speed', timer: player.speedTimer, max: player.speedMax});

            if (activeItems.length > 0) {
                let iconRadius = 22;
                let padding = 15;
                let totalWidth = activeItems.length * (iconRadius * 2) + (activeItems.length - 1) * padding;
                let startX = (canvas.width - totalWidth) / 2;
                let y = canvas.height - 35; // Cach day man hinh

                for (let i = 0; i < activeItems.length; i++) {
                    let item = activeItems[i];
                    let x = startX + i * (iconRadius * 2 + padding) + iconRadius;

                    ctx.save();
                    // Ve nen vong tron trang
                    ctx.beginPath();
                    ctx.arc(x, y, iconRadius, 0, Math.PI*2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fill();
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#333';
                    ctx.stroke();

                    // Ve Icon vat pham
                    ctx.save();
                    ctx.translate(x, y);
                    if (item.type === 'spring') drawSpringIcon(ctx);
                    else if (item.type === 'star') drawStarIcon(ctx);
                    else if (item.type === 'gun') { ctx.scale(0.8, 0.8); drawGunIcon(ctx); }
                    else if (item.type === 'speed') drawSpeedIcon(ctx);
                    ctx.restore();

                    // Ve lop den mo (pie chart) the hien thoi gian da troi qua
                    let percentLeft = item.timer / item.max;
                    let percentPassed = 1 - percentLeft;
                    
                    if (percentPassed > 0) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        let startAngle = -Math.PI/2; // Bat dau tu dinh (12 gio)
                        let endAngle = startAngle + (Math.PI * 2 * percentPassed);
                        ctx.arc(x, y, iconRadius, startAngle, endAngle);
                        ctx.closePath();
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                        ctx.fill();
                    }
                    ctx.restore();
                }
            }
        }

        function gameLoop() { update(); draw(); requestAnimationFrame(gameLoop); }
        window.onload = function() { initGame(); gameLoop(); };

        function showMessage(msg) { 
            messageBox.innerText = msg; 
            messageBox.style.display = 'block'; 
            setTimeout(() => messageBox.style.display = 'none', 1500); 
        }
    </script>
</body>
</html>
